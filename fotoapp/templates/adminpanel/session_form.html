{% extends "adminpanel/base_adminpanel.html" %}
{% block content %}

<div class="container-fluid p-0">

    <div class="toolbar-container mb-4">
        <div class="d-flex align-items-center">
            <a href="{% url 'panel_sessions' %}" class="btn btn-outline-light me-4" style="border-radius: 8px;">
                &larr; Wróć
            </a>

            <h2 class="toolbar-title m-0">
                {% if session %}Edycja sesji{% else %}Nowa sesja{% endif %}
            </h2>
        </div>
    </div>
    
    {% if messages %}
        {% for m in messages %}
            <div class="alert alert-{% if m.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
                {{ m }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Zamknij"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST" class="card p-4 mb-4 shadow-sm">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">Nazwa sesji</label>
            <input type="text" name="name" class="form-control" value="{{ session.name|default:'' }}" required>
        </div>

        <div class="mb-3">
            <label for="id_password" class="form-label">Hasło sesji</label>
            <input type="text" name="password" id="id_password" class="form-control" value="{{ session.password|default:'' }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Opis</label>
            <textarea name="description" class="form-control">{{ session.description|default:'' }}</textarea>
        </div>

        <button type="submit" class="btn btn-success">{% if session %}Zapisz sesję{% else %}Utwórz sesję{% endif %}</button>
    </form>
</div>

{% if session %}
<div class="container-fluid p-0">

    <div id="preview-grid" class="d-flex flex-wrap mb-3"></div>

    <form id="upload-form" class="card upload-dropzone mb-4 shadow-sm text-center"
          enctype="multipart/form-data">
        <input type="file" name="images" multiple id="file-input" style="display:none;">
        
        <div style="padding: 50px; display:flex; align-items:center; justify-content:center; flex-direction:column; width:100%; height:100%;">
            <p class="text-muted" style="margin-bottom: 5px;">Przeciągnij i upuść zdjęcia tutaj lub kliknij, aby wybrać</p>
            <button type="submit" class="btn btn-primary mt-2">Zapisz zdjęcia</button>
        </div>
    </form>
    
    <div class="card p-3 mb-4">
        <h5>Ustaw cenę dla wszystkich zdjęć</h5>

        <div class="d-flex align-items-center">
            <input type="number" step="0.01" id="mass-price-input" class="form-control me-3" style="width: 150px;">
            <button class="btn btn-primary" id="mass-price-btn">Ustaw</button>
            <span class="text-success ms-3 d-none" id="mass-price-status">✔ Zaktualizowano</span>
        </div>
    </div>
    
    <div id="photo-grid">
        {% include "adminpanel/partials/photo_grid.html" %}
    </div>
</div>

<script>
// --- Drag & Drop + podgląd ---
const dropZone = document.getElementById('upload-form');
const fileInput = document.getElementById('file-input');
const previewGrid = document.getElementById('preview-grid');

// Upewniamy się, że dropZone działa nawet jeśli klikniemy na przycisk wewnątrz
dropZone.addEventListener('click', e => { 
    if(e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT") fileInput.click(); 
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#777'; });
dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#bbb'; });
dropZone.addEventListener('drop', e => { 
    e.preventDefault(); 
    fileInput.files = e.dataTransfer.files; 
    showPreview(fileInput.files); 
});

fileInput.addEventListener('change', () => showPreview(fileInput.files));

function showPreview(files) {
    previewGrid.innerHTML = '';
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.height = '120px';
            img.style.margin = '5px';
            img.style.objectFit = 'cover';
            img.style.border = '1px solid #ccc';
            img.style.borderRadius = '4px';
            previewGrid.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

// --- Upload zdjęć (AJAX) ---
dropZone.addEventListener('submit', e => {
    e.preventDefault();
    const files = fileInput.files;
    if(!files.length) return;

    const formData = new FormData();
    Array.from(files).forEach(f => formData.append('images', f));

    fetch("{% url 'panel_session_photos_upload' session.id %}", {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        body: formData
    })
    .then(resp => resp.text())
    .then(html => {
        document.getElementById('photo-grid').innerHTML = html;
        previewGrid.innerHTML = '';
        fileInput.value = '';
        alert("Zdjęcia przesłane pomyślnie!");
    });
});

// --- AJAX dla Ustaw okładkę i Usuń ---
document.getElementById('photo-grid').addEventListener('click', function(e) {
    if(e.target.tagName === 'A' && (e.target.innerText.trim() === 'Ustaw okładkę' || e.target.innerText.trim() === 'Usuń')) {
        e.preventDefault();
        const url = e.target.href;
        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(resp => resp.json())
        .then(data => {
            document.getElementById('photo-grid').innerHTML = data.html;
        });
    }
});

// --- AJAX dla ustawiania ceny pojedynczego zdjęcia ---
document.querySelectorAll(".save-price-btn").forEach(btn => {
    btn.addEventListener("click", () => {

        const photoId = btn.dataset.photoId;
        const input = document.querySelector(`.price-input[data-photo-id="${photoId}"]`);
        const status = btn.parentElement.querySelector(".price-status");

        const formData = new FormData();
        formData.append("price", input.value);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        fetch(`/admin/photos/${photoId}/update-price/`, {
            method: "POST",
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                status.classList.remove("d-none");
                setTimeout(() => status.classList.add("d-none"), 1500);
            }
        });
    });
});
// --- AJAX dla ustawiania ceny wszystkich zdjęć ---
document.getElementById("mass-price-btn").addEventListener("click", () => {
    const price = document.getElementById("mass-price-input").value;
    const status = document.getElementById("mass-price-status");
    const formData = new FormData();
    formData.append("price", price);
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
    fetch(`/admin/sessions/{{ session.id }}/set-price-all/`, {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.querySelectorAll(".price-input").forEach(inp => inp.value = price);
            status.classList.remove("d-none");
            setTimeout(() => status.classList.add("d-none"), 1500);
        }
    });
});
</script>
{% endif %}
{% endblock %}